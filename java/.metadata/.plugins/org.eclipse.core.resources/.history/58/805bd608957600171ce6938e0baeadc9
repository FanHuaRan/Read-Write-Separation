package com.fhr.readwritedemo.core.services.impl;

import java.io.IOException;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.fhr.readwritedemo.core.models.DataBaseInfo;
import com.fhr.readwritedemo.core.models.dto.OSystemMonitInfo;
import com.fhr.readwritedemo.core.services.IDSCommunicate;
import com.fhr.readwritedemo.core.services.IDSMonitor;
import com.google.common.util.concurrent.Monitor;

/**
 * 基于udp的数据库服务器监控器
 * 
 * @author fhr
 * @since 2017/07/31
 */
@Service
public class UdpDSMonitor implements IDSMonitor {
	private static final Logger logger = Logger.getLogger(UdpDSMonitor.class);

	// 数据库服务器上运行的检测程序的端口硬编码为了16081
	private static final int PORT = 16081;
	// 检测周期
	private static final int PERIOD = 30;
	// 内存占用率严重限度 
	public static final double MEMORY_SERIOUS_RATE=0.9;
	// cpu占用率警告限度 缺省90%
	public static final double CPU_WARING_RATE;
	// cpu占用率严重限度 缺省95%
	public static final double CPU_SERIOUS_RATE;	
	// 数据库信息映射 key为host value为数据库信息对象
	private Map<String,DataBaseInfo> dataBaseInfos;
	// 定时任务线程池
	private final ScheduledExecutorService executorService = Executors.newSingleThreadScheduledExecutor();
	// 数据库服务器通讯组件
	@Autowired
	private IDSCommunicate dSCommunicate;

	@Override
	public void start() {
		// 监控信息
		Map<String,Monitor>
		executorService.scheduleAtFixedRate(() -> {
			for(Entry<String,DataBaseInfo> entry:dataBaseInfos.entrySet()){
				
			}
			
			for (final DataBaseInfo dataBaseInfo : dataBaseInfos) {
				OSystemMonitInfo oSystemMonitInfo = dSCommunicate.getInfo(dataBaseInfo.getHost(), PORT);
			}
			// 如何回调
		}, PERIOD, 0, TimeUnit.SECONDS);
	}

	@Override
	public void close() throws IOException {
		// 关闭定时任务
		executorService.shutdown();
	}

}
