package com.fhr.readwritedemo.components;

import java.io.IOException;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import org.apache.log4j.Logger;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.support.WebApplicationContextUtils;

/**
 * web生命周期监听器
 * @author fhr
 * @date 2017/06/12
 */
public class InitListener implements ServletContextListener {
	private static final Logger logger = Logger.getLogger(InitListener.class);
	// office产品转换服务 会作为独立进程运行
	private IOfficeToPDFComponent officeToPDF = null;

	@Override
	public void contextDestroyed(ServletContextEvent arg0) {
		// 关闭office产品转换服务
		try {
			officeToPDF.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	@Override
	public void contextInitialized(ServletContextEvent arg0) {
		//获取spring上下文
		WebApplicationContext springContext = WebApplicationContextUtils
				.getWebApplicationContext(arg0.getServletContext());
		if (springContext == null) {
			logger.error("初始化错误 未找到spring上下文");
		} else {
			officeToPDF = (IOfficeToPDFComponent) springContext.getBean(BaseOFOfficeToPDFComponent.class);
			if (officeToPDF != null) {
				new Thread(() -> {
					try {
						officeToPDF.start();
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}).start();
			} else {
				logger.error("初始化错误 未找到office服务组件");
			}
		}
	}

}
